name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Download code from GitHub
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Build the Docker Image
    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-capstone:latest ./app

    # 4. Security Scan (Academic Requirement: Trivy)
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.DOCKER_USERNAME }}/devops-capstone:latest'
        format: 'table'
        exit-code: '0' # Don't break the build for now, just report
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    # 5. Push Image to Docker Hub
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/devops-capstone:latest

    # 6. Deploy to AWS Server via SSH
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Install Docker if not present (Safety Check)
          if ! command -v docker &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y docker.io
          fi
          
          # Stop old container
          sudo docker stop my-website || true
          sudo docker rm my-website || true
          
          # Pull new image
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/devops-capstone:latest
          
          # Run new container
          sudo docker run -d --name my-website -p 80:80 ${{ secrets.DOCKER_USERNAME }}/devops-capstone:latest